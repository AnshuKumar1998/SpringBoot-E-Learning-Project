<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard</title>
    <link href="/assets/css/bootstrap.css" rel="stylesheet" />
    <link href="/assets/css/font-awesome.css" rel="stylesheet" />
    <link href="/assets/css/custom.css" rel="stylesheet" />
    <script>
		
        // Fetch student data and populate logout section with email
		
		
		
		function parseJwt(token) {
		    const base64Url = token.split('.')[1];
		    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
		    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
		        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
		    }).join(''));
		    return JSON.parse(jsonPayload);
		}
		
		
		
		async function fetchStudentAllData() {
		    const token = localStorage.getItem('token');
		    if (!token) {
		        alert('No token found. Please log in again.');
		        window.location.href = '/login';
		        return;
		    }

		    try {
		        const response = await fetch('/api/students/all-student-data-list', {
		            method: 'GET',
		            headers: { 'Authorization': `Bearer ${token}` },
		        });
				
				console.log("ok = "+response.ok)
				console.log("response = "+response)

		        if (response.ok) {
		            const students = await response.json();
		            displayStudentData(students);
		        } else {
		            const errorData = await response.json();
		            alert(`Failed to fetch all student data: ${errorData.message}`);
		        }
		    } catch (error) {
		        console.error('Error fetching all student data:', error);
		        alert('An error occurred while fetching all student data.');
		    }
		}

		// Function to display student data in the table
		function displayStudentData(students) {
		    const tableContainer = document.getElementById('studentTableContainer');
		    tableContainer.innerHTML = ''; // Clear existing data

		    if (students.length === 0) {
		        const message = document.createElement('p');
		        message.classList.add('error-message');
		        message.textContent = 'No students found.';
		        tableContainer.appendChild(message);
		        return;
		    }

		    // Create table dynamically
		    const table = document.createElement('table');
		    table.className = 'table';

		    // Create table header
		    const thead = document.createElement('thead');
		    thead.innerHTML = `
		        <tr>
		            <th scope="col">Sl. No.</th>
		            <th scope="col">Student Name</th>
		            <th scope="col">Email</th>
		            <th scope="col">Gender</th>
		            <th scope="col">Mobile No.</th>
		            <th scope="col">Date of Birth</th>
		            <th scope="col">Address</th>
		            <th scope="col">Action</th>
		        </tr>
		    `;
		    table.appendChild(thead);

		    // Create table body
		    const tbody = document.createElement('tbody');

		    students.forEach((student, index) => {
		        const row = document.createElement('tr');
		        row.innerHTML = `
		            <td>${index + 1}</td>
		            <td>${student.name}</td>
		            <td>${student.email}</td>
		            <td>${student.gender}</td>
		            <td>${student.mobileNumber}</td>
		            <td>${student.dob}</td>
		            <td>${student.address}</td>
		            <td>
				
					    <button type="button" class="btn btn-primary" onclick="showUpdateConfirmation(student)">Update</button>
					    <button type="button" class="btn btn-danger" onclick="showDeleteConfirmation(student.id)">Delete</button>
					

		            </td>
		        `;
		        tbody.appendChild(row);
		    });

		    table.appendChild(tbody);
		    tableContainer.appendChild(table);
		}


		function displayStudentDetails(student) {
		    document.getElementById('studentId').innerText = student.id;
		    document.getElementById('studentName').innerText = student.name;
		    document.getElementById('studentEmail').innerText = student.email;
		    document.getElementById('studentMobileNumber').innerText = student.mobileNumber;
		    document.getElementById('studentGender').innerText = student.gender;
		    document.getElementById('studentAddress').innerText = student.address;
		    document.getElementById('studentDob').innerText = student.dob;
		}

		
		
		
		async function fetchStudentData() {
		    const token = localStorage.getItem('token');
		    if (!token) {
		        alert('No token found. Please log in again.');
		        window.location.href = '/login';
		        return;
		    }

		    try {
		        const response = await fetch('/api/students/studentdata', {
		            method: 'GET',
		            headers: { 'Authorization': `Bearer ${token}` },
		        });

		        if (response.ok) {
		            const studentData = await response.json();
					displayStudentDetails(studentData);
					
		            document.getElementById('studentHeadingName').innerText = "Hello, " + studentData.name;
		            document.getElementById('studentheadingEmail').innerText = studentData.email;
					
					
					console.log(studentData);
					const imagePath = studentData.imageBase64.replace('src/main/resources/static', ''); 
					document.getElementById('studentImage').src = imagePath; 
				
					const token = localStorage.getItem('token');
					const data = parseJwt(token);
					console.log("hello");
					console.log("data = "+data);
					console.log("data = "+data['role']);
					if(data['role'] == "ROLE_TEACHER"){
						fetchStudentAllData();
					}
					

		        } else {
		            const errorData = await response.json();
		            alert(`Failed to fetch student data: ${errorData.message}`);
		        }
		    } catch (error) {
		        console.error('Error fetching student data:', error);
		        alert('An error occurred while fetching student data.');
		    }
		}


        // Log out function
        function logOutFun() {
            localStorage.removeItem('token');
            window.location.href = '/api/students/login';
        }

        // Toggle submenu for Assignments
        function toggleAssignmentsMenu() {
            const submenu = document.getElementById('assignmentSubmenu');
            submenu.classList.toggle('show');
        }

        window.onload = fetchStudentData;
    </script>
    <style>
        /* Dropdown styling for logout section */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .show {
            display: block;
        }
    </style>
</head>
<body>
    <div id="wrapper">
        <!-- Navbar -->
        <div class="navbar navbar-inverse navbar-fixed-top">
            <div class="adjust-nav">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".sidebar-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/api/students/"><i class="fa fa-square-o "></i>&nbsp;E-LEARNING</a>
                </div>
                <div class="navbar-collapse collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li class="dropdown">
                            <a href="#" id="studentheadingEmail">Loading...</a>
                            <div class="dropdown-content">
                                <a href="#" onclick="logOutFun()">Logout</a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- /. NAV TOP  -->
        
        <!-- Sidebar -->
        <nav class="navbar-default navbar-side" role="navigation">
            <div class="sidebar-collapse">
                <ul class="nav" id="main-menu">
                    <li class="text-center user-image-back" style="text-align: center; background-color: white; padding: 20px;">
						<img id="studentImage" src="/assets/img/find_user.png" class="img-responsive" alt="Student Image" style="width: 150px; height: 150px;" />

                    </li>

                    <li><a href="/api/students/dashboard"><i class="fa fa-desktop "></i>Dashboard</a></li>
                    <li><a href="#"><i class="fa fa-table "></i>Fee Payment</a></li>
                    <li><a href="#"><i class="fa fa-edit "></i>Forms </a></li>
                    
                    <!-- Assignment Menu -->
                    <li>
                        <a href="#" onclick="toggleAssignmentsMenu()"><i class="fa fa-sitemap "></i>Assignments <span class="fa arrow"></span></a>
                        <ul id="assignmentSubmenu" class="nav nav-second-level" style="display:none;">
                            <li><a href="#">Hindi Assignment</a></li>
                            <li><a href="#">English Assignments</a></li>
                            <li>
                                <a href="#">Math Assignments <span class="fa arrow"></span></a>
                                <ul class="nav nav-third-level">
                                    <li><a href="#">Assignment 1</a></li>
                                    <li><a href="#">Assignment 2</a></li>
                                    <li><a href="#">Assignment 3</a></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
					
					
					<li><a href="#"><i class="fa fa-bar-chart-o"></i>Fee Payment</a></li>
                    <li><a href="#"><i class="fa fa-bar-chart-o"></i>Performance Chart</a></li>
                    <li><a href="#"><i class="fa fa-edit "></i>Class Time Table</a></li>
					<li><a href="#"><i class="fa fa-edit "></i>Notice</a></li>
                    <li><a href="blank.html"><i class="fa fa-table "></i>Holiday Chart</a></li>
					<li><a href="#" onclick="logOutFun()"><i class="fa fa-sign-out"></i>Logout</a></li>
                </ul>
            </div>
        </nav>
        <!-- /. NAV SIDE  -->

        <!-- Page Content -->
        <div id="page-wrapper">
            <div id="page-inner">
                <div class="row">
                    <div class="col-md-12">
                        <h2 id="studentHeadingName"></h2>
                    </div>
			
                </div>
				<div class="row">
			
					<div class="col-md-6">
					       <h5>User Details</h5>
					       <div id="userDetails">
					           <p><strong>ID:</strong> <span id="studentId"></span></p>
					           <p><strong>Name:</strong> <span id="studentName"></span></p>
					           <p><strong>Email:</strong> <span id="studentEmail"></span></p>
					           <p><strong>Mobile Number:</strong> <span id="studentMobileNumber"></span></p>
					           <p><strong>Gender:</strong> <span id="studentGender"></span></p>
					           <p><strong>Address:</strong> <span id="studentAddress"></span></p>
					           <p><strong>DOB:</strong> <span id="studentDob"></span></p>
					       </div>
					   </div>
					
                  
               </div>
               <!-- /. ROW  -->
			   <!-- Service Start -->
			   <div id="studentTableContainer"></div>
			       <!-- Service End -->
				   <!-- Update Modal -->
				   <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
				       <div class="modal-dialog">
				           <div class="modal-content">
				               <div class="modal-header">
				                   <h5 class="modal-title" id="updateModalLabel">Update Student</h5>
				                   <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				               </div>
				               <div class="modal-body">
				                   <form id="updateForm">
				                       <input type="hidden" id="studentId" />
				                       <div class="mb-3">
				                           <label for="studentName" class="form-label">Name</label>
				                           <input type="text" class="form-control" id="studentName" required />
				                       </div>
				                       <div class="mb-3">
				                           <label for="studentEmail" class="form-label">Email</label>
				                           <input type="email" class="form-control" id="studentEmail" required />
				                       </div>
				                       <!-- Add other fields like gender, mobile number, DOB, address -->
				                       <button type="submit" class="btn btn-primary">Update</button>
				                   </form>
				               </div>
				           </div>
				       </div>
				   </div>

                <!-- /. ROW  -->
            </div>
            <!-- /. PAGE INNER  -->
        </div>
        <!-- /. PAGE WRAPPER  -->
    </div>
    <!-- /. WRAPPER  -->

    <script src="/assets/js/jquery-1.10.2.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/custom.js"></script>
	
	
	
	<script>
		
		</script>
	
	
</body>
</html>
